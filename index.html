<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Constvyu - Construction Timelapse Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Range slider styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #475569;
            border-radius: 2px;
        }
        
        /* Animation for recording indicator */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-pulse {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Icons Helper ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current) {
                    const iconNode = window.lucide.icons[name];
                    if (iconNode) {
                        const svgElement = iconNode.toSvg({
                            class: className,
                            width: size,
                            height: size,
                            "stroke-width": 2
                        });
                        ref.current.innerHTML = svgElement;
                    }
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center" />;
        };

        // --- Constants ---
        const MOCK_PROJECT = {
            id: 'PRJ-2024-001',
            name: 'Skyline Plaza Redevelopment',
            location: '124 Market St, Downtown',
            startDate: '2024-01-15',
            status: 'Active'
        };

        const MOCK_CAMERAS = [
            { id: 'cam-01', name: 'Tower Crane 1', status: 'Online', location: 'North Elevation' },
            { id: 'cam-02', name: 'Gate Entry', status: 'Online', location: 'Main Entrance' },
        ];

        // Generate sequential mock frames
        const generateMockFrames = () => {
            const frames = [];
            const baseDate = new Date('2024-01-01');
            
            // Generate 10 frames, one week apart
            for (let i = 0; i < 10; i++) {
                const date = new Date(baseDate);
                date.setDate(baseDate.getDate() + (i * 7));
                
                const dateStr = date.toISOString().split('T')[0];
                const progress = (i + 1) * 10;
                // Alternating colors to visualize change
                const color = i % 2 === 0 ? '1e40af' : '3b82f6'; 
                
                frames.push({
                    id: `mock-${i}`,
                    date: dateStr,
                    time: '10:00 AM',
                    imageUrl: `https://placehold.co/1200x800/${color}/FFFFFF/png?text=Week+${i+1}+(${dateStr})`,
                    thumbnailUrl: `https://placehold.co/300x200/${color}/FFFFFF/png?text=W${i+1}`
                });
            }
            return frames;
        };

        const MOCK_FRAMES = generateMockFrames();

        // --- Components ---

        const Header = ({ project, toggleSidebar }) => {
            return (
                <header className="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 md:px-6 shrink-0 z-20">
                    <div className="flex items-center">
                        <button onClick={toggleSidebar} className="mr-4 p-2 text-gray-500 hover:bg-gray-100 rounded-lg md:hidden">
                            <Icon name="menu" size={20} />
                        </button>
                        <div className="flex flex-col">
                            <h1 className="text-lg font-bold text-gray-900 leading-tight">{project.name}</h1>
                            <div className="flex items-center text-xs text-gray-500 mt-0.5">
                                <span className="flex items-center mr-1"><Icon name="map-pin" size={10} className="mr-1"/></span>
                                {project.location}
                                <span className="mx-2">•</span>
                                <span className="px-1.5 py-0.5 rounded-full text-[10px] font-medium border bg-green-50 text-green-700 border-green-200">
                                    {project.status}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div className="flex items-center space-x-3">
                        <div className="h-8 w-8 rounded-full bg-indigo-100 border border-indigo-200 flex items-center justify-center text-indigo-700 font-bold text-xs">
                            JD
                        </div>
                    </div>
                </header>
            );
        };

        const Sidebar = ({ isOpen, activeTab, setActiveTab, onFolderSelect }) => {
            const fileInputRef = useRef(null);
            const menuItems = [
                { id: 'timelapse', label: 'Timelapse', iconName: 'clock' },
                { id: 'compare', label: 'Compare', iconName: 'sliders-horizontal' },
                { id: 'live-view', label: 'Live View', iconName: 'camera' },
            ];

            return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" />}
                    <aside className={`fixed md:relative z-30 flex flex-col w-64 h-full bg-white border-r border-gray-200 transform transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="h-16 flex items-center px-6 border-b border-gray-200">
                            <div className="flex items-center space-x-2 text-indigo-600">
                                <Icon name="camera" size={24} className="text-indigo-600" />
                                <span className="text-xl font-bold tracking-tight text-gray-900">Constvyu</span>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto py-6 px-3">
                            <nav className="space-y-1">
                                {menuItems.map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => setActiveTab(item.id)}
                                        className={`w-full flex items-center space-x-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-all ${activeTab === item.id ? 'bg-indigo-50 text-indigo-700 shadow-sm ring-1 ring-indigo-200' : 'text-gray-600 hover:bg-gray-50'}`}
                                    >
                                        <Icon name={item.iconName} size={18} className={activeTab === item.id ? 'text-indigo-600' : 'text-gray-400'} />
                                        <span>{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                            <div className="mt-8 px-3">
                                <button 
                                    onClick={() => fileInputRef.current?.click()}
                                    className="w-full flex flex-col items-center justify-center px-4 py-6 border-2 border-dashed border-gray-300 rounded-xl hover:border-indigo-400 hover:bg-indigo-50 transition-all group cursor-pointer"
                                >
                                    <div className="text-gray-400 group-hover:text-indigo-500 mb-2">
                                        <Icon name="folder-open" size={24} />
                                    </div>
                                    <span className="text-xs font-medium text-gray-600">Import Local Folder</span>
                                </button>
                                <input type="file" ref={fileInputRef} className="hidden" webkitdirectory="" directory="" multiple onChange={(e) => e.target.files && onFolderSelect(e.target.files)} />
                            </div>
                        </div>
                    </aside>
                </>
            );
        };

        // --- TIMELAPSE PLAYER (Enhanced) ---
        const TimelapsePlayer = ({ frames, onFrameChange }) => {
            const sortedFrames = useMemo(() => {
                return [...frames].sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [frames]);

            const [currentIndex, setCurrentIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [speed, setSpeed] = useState(2); 
            const [isExporting, setIsExporting] = useState(false);
            const intervalRef = useRef(null);

            useEffect(() => {
                if (sortedFrames.length > 0) {
                    onFrameChange(sortedFrames[currentIndex]);
                }
            }, [currentIndex, sortedFrames, onFrameChange]);

            const togglePlay = () => {
                if (isPlaying) {
                    clearInterval(intervalRef.current);
                } else {
                    if (currentIndex === sortedFrames.length - 1) setCurrentIndex(0);
                }
                setIsPlaying(!isPlaying);
            };

            useEffect(() => {
                if (isPlaying) {
                    const ms = 500 / speed;
                    intervalRef.current = window.setInterval(() => {
                        setCurrentIndex(prev => {
                            if (prev >= sortedFrames.length - 1) {
                                setIsPlaying(false);
                                return prev;
                            }
                            return prev + 1;
                        });
                    }, ms);
                } else {
                    clearInterval(intervalRef.current);
                }
                return () => clearInterval(intervalRef.current);
            }, [isPlaying, sortedFrames.length, speed]);

            // --- Download Video Logic (FIXED) ---
            const handleDownloadVideo = async () => {
                if (isExporting || sortedFrames.length === 0) return;
                setIsExporting(true);

                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Load first image to set dimensions
                    const firstImg = new Image();
                    firstImg.crossOrigin = "anonymous";
                    await new Promise((resolve, reject) => {
                        firstImg.onload = resolve;
                        firstImg.onerror = () => reject("Failed to load first image. Tainted canvas issue possible.");
                        firstImg.src = sortedFrames[0].imageUrl;
                    });
                    
                    canvas.width = firstImg.naturalWidth || 1920;
                    canvas.height = firstImg.naturalHeight || 1080;
                    
                    // Setup recorder
                    const stream = canvas.captureStream(30); // 30 FPS stream
                    let mimeType = 'video/webm';
                    if (MediaRecorder.isTypeSupported('video/mp4')) {
                        mimeType = 'video/mp4';
                    } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
                        mimeType = 'video/webm;codecs=vp9';
                    }

                    const recorder = new MediaRecorder(stream, { mimeType });
                    const chunks = [];
                    recorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };
                    
                    recorder.start();

                    // Play frames onto canvas
                    for (let i = 0; i < sortedFrames.length; i++) {
                        const img = new Image();
                        img.crossOrigin = "anonymous"; // Important for CORS
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = () => {
                                console.warn(`Skipping broken frame ${i}`);
                                resolve(); // Skip error to keep recording
                            };
                            img.src = sortedFrames[i].imageUrl;
                        });
                        
                        // Clear and draw
                        ctx.fillStyle = 'black';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Add overlay text
                        ctx.fillStyle = 'rgba(0,0,0,0.5)';
                        ctx.fillRect(20, 20, 350, 60);
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 30px Arial';
                        ctx.fillText(sortedFrames[i].date, 40, 60);

                        // Manually trigger stream update if needed, but drawing should suffice.
                        // Wait a bit to simulate frame duration (approx 200ms per frame in video)
                        await new Promise(r => setTimeout(r, 200)); 
                    }
                    
                    // Stop recorder
                    recorder.stop();
                    
                    // Wait for stop event
                    await new Promise(resolve => {
                         recorder.onstop = resolve;
                    });

                    // Create blob after stop
                    if (chunks.length > 0) {
                        const blob = new Blob(chunks, { type: mimeType });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `timelapse-${sortedFrames[0].date}-to-${sortedFrames[sortedFrames.length-1].date}.${mimeType === 'video/mp4' ? 'mp4' : 'webm'}`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } else {
                        throw new Error("No video data recorded. Canvas might be tainted or recorder failed.");
                    }
                    
                    setIsExporting(false);

                } catch (err) {
                    console.error("Export failed:", err);
                    alert("Could not generate video. If using placeholder images, this is likely due to browser CORS security policies preventing canvas recording.");
                    setIsExporting(false);
                }
            };

            const currentFrame = sortedFrames[currentIndex];
            if (!sortedFrames.length) return null;

            return (
                <div className="flex flex-col h-full bg-slate-900 rounded-xl overflow-hidden shadow-2xl relative group">
                    {/* Main Viewport */}
                    <div className="flex-1 relative flex items-center justify-center bg-black min-h-0">
                        <img 
                            src={currentFrame.imageUrl} 
                            alt={`Frame ${currentFrame.date}`} 
                            className="w-full h-full object-contain"
                        />
                        
                        <div className="absolute top-6 left-6 bg-black/60 backdrop-blur-md text-white px-4 py-2 rounded-lg border border-white/10 shadow-lg pointer-events-none">
                            <div className="text-lg font-mono font-bold tracking-wider">{currentFrame.date}</div>
                            <div className="text-xs text-gray-300 mt-1">
                                {currentFrame.time} • Frame {currentIndex + 1}/{sortedFrames.length}
                            </div>
                        </div>

                        {isExporting && (
                            <div className="absolute inset-0 bg-black/80 z-50 flex flex-col items-center justify-center text-white">
                                <div className="w-16 h-16 border-4 border-t-indigo-500 border-white/20 rounded-full animate-spin mb-4"></div>
                                <h3 className="text-xl font-bold">Rendering Video...</h3>
                                <p className="text-gray-400 text-sm mt-2">Please wait while we process frames</p>
                            </div>
                        )}
                    </div>

                    {/* Controls Bar */}
                    <div className="bg-slate-800 border-t border-slate-700 p-4 shrink-0">
                        {/* Timeline Slider */}
                        <div className="mb-4 flex items-center space-x-4">
                            <span className="text-xs text-slate-400 font-mono w-16 text-right">
                                {(currentIndex + 1).toString().padStart(2, '0')} / {sortedFrames.length}
                            </span>
                            <input
                                type="range"
                                min="0"
                                max={sortedFrames.length - 1}
                                value={currentIndex}
                                onChange={(e) => {
                                    setCurrentIndex(parseInt(e.target.value));
                                    setIsPlaying(false);
                                }}
                                className="flex-1 h-2 bg-slate-600 rounded-full appearance-none cursor-pointer"
                            />
                        </div>

                        {/* Action Buttons */}
                        <div className="flex items-center justify-between">
                            <div className="flex bg-slate-700 rounded-lg p-1 space-x-1">
                                {[0.5, 1, 2, 4].map((s) => (
                                    <button 
                                        key={s} 
                                        onClick={() => setSpeed(s)} 
                                        className={`px-3 py-1.5 text-xs font-medium rounded transition-colors ${speed === s ? 'bg-indigo-600 text-white' : 'text-slate-300 hover:text-white hover:bg-slate-600'}`}
                                    >
                                        {s}x
                                    </button>
                                ))}
                            </div>

                            <div className="flex items-center space-x-6">
                                <button onClick={() => { setCurrentIndex(0); setIsPlaying(false); }} className="text-slate-400 hover:text-white transition-colors p-1">
                                    <Icon name="skip-back" size={20} />
                                </button>
                                
                                {/* RECTANGULAR PLAY BUTTON (User Request) */}
                                <button 
                                    onClick={togglePlay} 
                                    className={`
                                        flex items-center space-x-2 px-6 py-2 rounded-lg font-bold shadow-lg transition-all border-2 
                                        ${isPlaying 
                                            ? 'bg-slate-700 border-slate-600 text-white hover:bg-slate-600' 
                                            : 'bg-indigo-600 border-indigo-400 text-white hover:bg-indigo-500 hover:scale-105 active:scale-95'
                                        }
                                    `}
                                >
                                    {isPlaying ? (
                                        <>
                                            <Icon name="pause" size={20} className="fill-current" />
                                            <span>Pause</span>
                                        </>
                                    ) : (
                                        <>
                                            <Icon name="play" size={20} className="fill-current" />
                                            <span>Play</span>
                                        </>
                                    )}
                                </button>
                                
                                <button onClick={() => { setCurrentIndex(sortedFrames.length - 1); setIsPlaying(false); }} className="text-slate-400 hover:text-white transition-colors p-1">
                                    <Icon name="skip-forward" size={20} />
                                </button>
                            </div>

                            <button 
                                onClick={handleDownloadVideo}
                                disabled={isExporting}
                                className={`flex items-center space-x-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                    isExporting ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-slate-700 text-white hover:bg-slate-600'
                                }`}
                            >
                                <Icon name="download" size={16} />
                                <span>{isExporting ? 'Exporting...' : 'Download Video'}</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPARE VIEW ---
        const CompareView = ({ frames, leftIndex, setLeftIndex, rightIndex, setRightIndex }) => {
            const [sliderPosition, setSliderPosition] = useState(50);
            const containerRef = useRef(null);
            const [containerDimensions, setContainerDimensions] = useState({ width: 0, height: 0 });

            const sortedFrames = useMemo(() => {
                return [...frames].sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [frames]);

            useEffect(() => {
                if (!containerRef.current) return;
                const updateDimensions = () => {
                    if (containerRef.current) {
                        const { width, height } = containerRef.current.getBoundingClientRect();
                        setContainerDimensions({ width, height });
                    }
                };
                updateDimensions();
                const observer = new ResizeObserver(updateDimensions);
                observer.observe(containerRef.current);
                window.addEventListener('resize', updateDimensions);
                return () => {
                    observer.disconnect();
                    window.removeEventListener('resize', updateDimensions);
                };
            }, []);

            const handleMove = (clientX) => {
                if (!containerRef.current) return;
                const rect = containerRef.current.getBoundingClientRect();
                const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
                const percentage = (x / rect.width) * 100;
                setSliderPosition(percentage);
            };

            if (frames.length < 2) return <div className="w-full h-full bg-white rounded-xl flex items-center justify-center text-gray-400">Need 2+ frames to compare</div>;

            // Ensure indices are within bounds
            const safeLeft = Math.min(leftIndex, sortedFrames.length - 1);
            const safeRight = Math.min(rightIndex, sortedFrames.length - 1);

            return (
                <div className="flex-1 flex flex-col min-h-0 h-full">
                    {/* Viewport - Takes full height now, controls moved to sidebar */}
                    <div className="flex-1 bg-slate-900 rounded-xl overflow-hidden relative shadow-lg border border-slate-700 select-none touch-none flex items-center justify-center">
                        <div 
                            ref={containerRef}
                            className="relative w-full h-full cursor-ew-resize overflow-hidden"
                            onMouseMove={(e) => e.buttons === 1 && handleMove(e.clientX)}
                            onTouchMove={(e) => handleMove(e.touches[0].clientX)}
                            onClick={(e) => handleMove(e.clientX)}
                        >
                            <img src={sortedFrames[safeRight].imageUrl} className="absolute inset-0 w-full h-full object-contain object-center pointer-events-none select-none" alt="After" />
                            <div className="absolute inset-y-0 left-0 overflow-hidden border-r-2 border-white/80 shadow-[2px_0_10px_rgba(0,0,0,0.3)]" style={{ width: `${sliderPosition}%` }}>
                                <div style={{ width: containerDimensions.width, height: containerDimensions.height }}>
                                    <img src={sortedFrames[safeLeft].imageUrl} className="w-full h-full object-contain object-center pointer-events-none select-none" alt="Before" />
                                </div>
                            </div>
                            <div className="absolute inset-y-0 pointer-events-none flex items-center justify-center" style={{ left: `${sliderPosition}%`, transform: 'translateX(-50%)' }}>
                                <div className="w-8 h-8 bg-white rounded-full shadow-lg flex items-center justify-center text-indigo-600">
                                    <Icon name="sliders-horizontal" size={16} />
                                </div>
                            </div>
                            <div className="absolute top-4 left-4 bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur pointer-events-none">{sortedFrames[safeLeft].date} (Before)</div>
                            <div className="absolute top-4 right-4 bg-black/60 text-white text-xs px-2 py-1 rounded backdrop-blur pointer-events-none">{sortedFrames[safeRight].date} (After)</div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('timelapse');
            const [currentFrame, setCurrentFrame] = useState(null);
            const [allFrames, setAllFrames] = useState(MOCK_FRAMES);
            const [isUsingLocalData, setIsUsingLocalData] = useState(false);
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            // Hoisted State for Compare View
            const [compareLeftIndex, setCompareLeftIndex] = useState(0);
            const [compareRightIndex, setCompareRightIndex] = useState(0);

            useEffect(() => {
                if (allFrames.length > 0) {
                    const sorted = [...allFrames].sort((a, b) => new Date(a.date) - new Date(b.date));
                    setStartDate(sorted[0].date);
                    setEndDate(sorted[sorted.length - 1].date);
                    setCompareRightIndex(sorted.length - 1); // Set compare right to last frame
                }
            }, [allFrames]);

            const filteredFrames = useMemo(() => {
                return allFrames
                    .filter(frame => frame.date >= startDate && frame.date <= endDate)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [startDate, endDate, allFrames]);

            const sortedAllFrames = useMemo(() => {
                return [...allFrames].sort((a, b) => new Date(a.date) - new Date(b.date));
            }, [allFrames]);

            const handleFolderSelect = (fileList) => {
                const newFrames = [];
                const files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
                files.forEach((file, index) => {
                    const name = file.name;
                    let dateStr = new Date(file.lastModified).toISOString().split('T')[0];
                    const isoMatch = name.match(/(\d{4})[-_.](\d{2})[-_.](\d{2})/);
                    if (isoMatch) dateStr = `${isoMatch[1]}-${isoMatch[2]}-${isoMatch[3]}`;
                    const objectUrl = URL.createObjectURL(file);
                    newFrames.push({
                        id: `local-${index}`,
                        date: dateStr,
                        time: new Date(file.lastModified).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                        imageUrl: objectUrl,
                        thumbnailUrl: objectUrl
                    });
                });
                if (newFrames.length > 0) {
                    newFrames.sort((a, b) => new Date(a.date) - new Date(b.date));
                    setAllFrames(newFrames);
                    setIsUsingLocalData(true);
                    setStartDate(newFrames[0].date);
                    setEndDate(newFrames[newFrames.length - 1].date);
                    setCompareRightIndex(newFrames.length - 1);
                    alert(`Loaded ${newFrames.length} images sorted by date.`);
                } else {
                    alert("No images found.");
                }
            };

            return (
                <div className="flex h-screen w-full bg-gray-50 overflow-hidden font-sans">
                    <Sidebar isOpen={isSidebarOpen} activeTab={activeTab} setActiveTab={setActiveTab} onFolderSelect={handleFolderSelect} />
                    <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                        <Header project={MOCK_PROJECT} toggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)} />
                        <main className="flex-1 p-4 md:p-6 overflow-hidden relative flex flex-col bg-gray-100">
                            {/* Layout Container */}
                            <div className="flex-1 flex flex-col lg:flex-row h-full overflow-hidden gap-4">
                                
                                {/* MAIN CONTENT AREA */}
                                <div className="flex-1 flex flex-col min-w-0 h-full">
                                    <div className="flex items-center justify-between mb-2 shrink-0">
                                        <h1 className="text-xl font-bold text-gray-800">
                                            {activeTab === 'timelapse' ? 'Timelapse Monitor' : activeTab === 'compare' ? 'Side-by-Side Comparison' : 'Live View'}
                                            {isUsingLocalData && <span className="ml-3 px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full border border-green-200 font-medium align-middle">Local Source</span>}
                                        </h1>
                                        {activeTab === 'timelapse' && <span className="text-sm text-gray-500">{filteredFrames.length} frames selected</span>}
                                    </div>

                                    <div className="flex-1 relative min-h-0">
                                        {activeTab === 'timelapse' ? (
                                            filteredFrames.length > 0 ? (
                                                <TimelapsePlayer frames={filteredFrames} onFrameChange={setCurrentFrame} />
                                            ) : (
                                                <div className="w-full h-full bg-white rounded-xl shadow border border-gray-200 flex items-center justify-center flex-col text-gray-400">
                                                    <div className="mb-3 opacity-20"><Icon name="folder-open" size={48} /></div>
                                                    <p>No images in selected range.</p>
                                                </div>
                                            )
                                        ) : activeTab === 'compare' ? (
                                            <CompareView 
                                                frames={allFrames} 
                                                leftIndex={compareLeftIndex}
                                                setLeftIndex={setCompareLeftIndex}
                                                rightIndex={compareRightIndex}
                                                setRightIndex={setCompareRightIndex}
                                            />
                                        ) : (
                                            <div className="w-full h-full bg-slate-900 rounded-xl flex flex-col items-center justify-center text-gray-400">
                                                 <div className="mb-4 opacity-20"><Icon name="camera" size={64} /></div>
                                                 <h2 className="text-xl font-bold text-gray-300">Live Stream Offline</h2>
                                                 <p className="text-sm">Connect a camera to view live feed.</p>
                                            </div>
                                        )}
                                    </div>
                                    
                                    {/* Space Below Frame */}
                                    <div className="h-6 shrink-0"></div>
                                </div>

                                {/* RIGHT SIDEBAR (Controls) - DYNAMIC CONTENT */}
                                {activeTab !== 'live-view' && (
                                    <div className="w-full lg:w-80 bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col shrink-0 lg:h-auto overflow-hidden">
                                        <div className="p-4 border-b border-gray-100 bg-gray-50">
                                            <h3 className="font-semibold text-gray-800 flex items-center">
                                                <Icon name="settings-2" size={16} className="mr-2 text-indigo-600"/> 
                                                {activeTab === 'timelapse' ? 'Configuration' : 'Comparison Settings'}
                                            </h3>
                                        </div>
                                        
                                        <div className="p-5 flex flex-col gap-6 overflow-y-auto flex-1">
                                            {/* TIMELAPSE CONTROLS */}
                                            {activeTab === 'timelapse' && (
                                                <>
                                                    <div>
                                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 block">Data Source</label>
                                                        {isUsingLocalData ? (
                                                            <div className="w-full px-3 py-2 bg-indigo-50 border border-indigo-200 text-indigo-800 text-sm rounded-lg font-medium flex items-center">
                                                                <Icon name="folder-open" size={16} className="mr-2"/>
                                                                Local Folder
                                                                <button onClick={() => { setIsUsingLocalData(false); setAllFrames(MOCK_FRAMES); }} className="ml-auto text-xs hover:underline">Reset</button>
                                                            </div>
                                                        ) : (
                                                            <div className="text-sm text-gray-600 bg-gray-50 p-2 rounded border border-gray-200">
                                                                Using Mock Data
                                                            </div>
                                                        )}
                                                    </div>

                                                    <div>
                                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 block">Date Range</label>
                                                        <div className="space-y-3">
                                                            <div>
                                                                <span className="text-xs text-gray-400 block mb-1">From</span>
                                                                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                            </div>
                                                            <div>
                                                                <span className="text-xs text-gray-400 block mb-1">To</span>
                                                                <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" />
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div>
                                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 block">Quick Select</label>
                                                        <div className="grid grid-cols-2 gap-2">
                                                            <button onClick={() => {
                                                                const end = new Date(endDate || new Date());
                                                                const start = new Date(end); start.setDate(end.getDate() - 7);
                                                                setStartDate(start.toISOString().split('T')[0]);
                                                            }} className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs font-medium text-gray-600 transition-colors">Last 7 Days</button>
                                                            <button onClick={() => {
                                                                const end = new Date(endDate || new Date());
                                                                const start = new Date(end); start.setDate(end.getDate() - 30);
                                                                setStartDate(start.toISOString().split('T')[0]);
                                                            }} className="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs font-medium text-gray-600 transition-colors">Last 30 Days</button>
                                                            <button onClick={() => {
                                                                if(allFrames.length){
                                                                    const sorted = [...allFrames].sort((a,b)=>new Date(a.date)-new Date(b.date));
                                                                    setStartDate(sorted[0].date); setEndDate(sorted[sorted.length-1].date);
                                                                }
                                                            }} className="col-span-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-xs font-medium text-gray-600 transition-colors">Reset to All Time</button>
                                                        </div>
                                                    </div>
                                                </>
                                            )}

                                            {/* COMPARE CONTROLS (Moved from top to here) */}
                                            {activeTab === 'compare' && (
                                                <>
                                                    <div>
                                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 block flex items-center">
                                                            <span className="w-2 h-2 bg-indigo-500 rounded-full mr-2"></span>Left Image (Before)
                                                        </label>
                                                        <select 
                                                            className="w-full p-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500"
                                                            value={compareLeftIndex}
                                                            onChange={(e) => setCompareLeftIndex(Number(e.target.value))}
                                                        >
                                                            {sortedAllFrames.map((f, i) => (
                                                                <option key={f.id} value={i}>
                                                                    {f.date} {f.time}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        {sortedAllFrames[compareLeftIndex] && (
                                                            <div className="mt-2 rounded-lg overflow-hidden h-32 border border-gray-200">
                                                                <img src={sortedAllFrames[compareLeftIndex].thumbnailUrl} className="w-full h-full object-cover" alt="Preview Left" />
                                                            </div>
                                                        )}
                                                    </div>

                                                    <div className="h-px bg-gray-100"></div>

                                                    <div>
                                                        <label className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 block flex items-center">
                                                            <span className="w-2 h-2 bg-white border-2 border-indigo-500 rounded-full mr-2"></span>Right Image (After)
                                                        </label>
                                                        <select 
                                                            className="w-full p-2.5 text-sm border border-gray-200 rounded-lg bg-gray-50 outline-none focus:ring-2 focus:ring-indigo-500"
                                                            value={compareRightIndex}
                                                            onChange={(e) => setCompareRightIndex(Number(e.target.value))}
                                                        >
                                                            {sortedAllFrames.map((f, i) => (
                                                                <option key={f.id} value={i}>
                                                                    {f.date} {f.time}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        {sortedAllFrames[compareRightIndex] && (
                                                            <div className="mt-2 rounded-lg overflow-hidden h-32 border border-gray-200">
                                                                <img src={sortedAllFrames[compareRightIndex].thumbnailUrl} className="w-full h-full object-cover" alt="Preview Right" />
                                                            </div>
                                                        )}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
